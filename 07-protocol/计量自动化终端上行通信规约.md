

# 物理层

## TCP 和 UDP 的传输接口
该类接口的登录链接和心跳检测采用链路测试服务，链路测试周期可设定。 
参见 TCP/IP 协议规范。

## 串行通信传输接口

字节传输按异步方式进行，它包含 8 个数据位、1 个起始位“0”、1 个偶校验位 P 和 1 个停止位“1”。

## 红外通信传输接口
采用红外通信方式实现当地数据传输时，字节格式与串行通信传输格式相同，在发送数据时，在有效数据帧前加 1~4 个 FEH 作为前导码。

## PSTN 通信传输接口
话音 MODEM 需支持 CCITT V.22bis、V.32bis、V.34、V.90、V.92 标准协议，支持 V.42、MNP 等纠错协议和 V.42bis、MNP5 等数据压缩协议，通信速率支持 1200bps~56 kbps。 

## 音频专线通信传输接口
音频专线 MODEM 支持 V.23 标准，中心频率为 1700Hz，发送“1”，频率为 1300Hz，发送“0”，频
率为 2100Hz，通信速率为 300bps~1200bps。

# 帧格式


| 起始字符68H | 长度L | 起始字符68H | 控制域C | 地址域A | 应用数据 | 校验和CS | 结束字符16H |
| :---------: | :---: | :---------: | :-----: | :-----: | :------: | :------: | :---------: |
|    1Byte    | 2Byte |    1Byte    |  1Byte  |  7Byte  |  N Byte  |  1Byte   |    1Byte    |

帧的基本单元为 8 位字节。链路层传输顺序为低位在前，高位在后；低字节在前，高字节在后。


## 长度

用户数据长度 L 采用 BIN 编码，是控制域、地址域、链路用户数据（应用层）的字节总数。
- 采用专用无线数传信道，长度 L 不大于 255；
- 采用 GPRS/CDMA 传输，长度 L 不大于 1024；
- 采用网络传输，长度 L 不大于 16383。

## 控制域

|          |      D7       |      D6       |      D5       |       D4        | D3~D0  |
| :------: | :-----------: | :-----------: | :-----------: | :-------------: | :----: |
| 下行方向 | 传输方向位DIR | 启动标志位PRM |  帧计数位FCB  | 帧计数有效位FCV | 功能码 |
| 上行方向 | 传输方向位DIR | 启动标志位PRM | 要求访问位ACD |      保留       | 功能码 |


### 传输方向位 DIR

DIR=0：表示此帧报文是由主站发出的下行报文； 
DIR=1：表示此帧报文是由终端发出的上行报文。


### 启动标志位 PRM

- PRM =1：表示此帧报文来自启动站；
- PRM =0：表示此帧报文来自从动站。

### 帧计数位 FCB 

当帧计数有效位 FCV=1 时，FCB 表示每个站连续的发送/确认或者请求/响应服务的变化位。FCB位用来防止信息传输的丢失和重复。

启动站向同一从动站传输新的发送/确认或请求/响应传输服务时，将 FCB 取相反值。启动站保存每一个从动站 FCB 值，若超时未收到从动站的报文，或接收出现差错，则启动站不改变 FCB 的状态，重复原来的发送/确认或者请求/响应服务。 

复位命令中的 FCB=0，从动站接收复位命令后将 FCB 置“0”。 

### 请求访问位 ACD 

ACD 位用于上行响应报文中：

- ACD=1 表示终端有告警数据等待访问，主站在本次通信服务结束后可以发起召读告警数据；
- ACD=0 表示终端无告警数据等待访问。 

ACD 置“1”和置“0”规则： 

- 自上次收到报文后发生新的告警并且主动上送不成功，ACD 位置“1”； 
- 收到主站请求告警报文并执行后，ACD 位置“0”。 

### 帧计数有效位 FCV 

- FCV=1：表示 FCB 位有效；
- FCV=0：表示 FCB 位无效。

### 功能码
  
当启动标志位 PRM =1 时，


| 功能码 |   帧类型    |  服务功能   |
| :----: | :---------: | :---------: |
|   0    |      -      |    备用     |
|   1    |  发送/确认  |  复位命令   |
|  2~3   |      -      |    备用     |
|   4    | 发送/无回答 |  用户数据   |
|  5~8   |      -      |    备用     |
|   9    | 请求/响应帧 |  链路测试   |
|   10   | 请求/响应帧 | 请求1级数据 |
|   11   | 请求/响应帧 | 请求2级数据 |
| 12~15  |      -      |    备用     |

当启动标志位 PRM =0 时，

| 功能码 | 帧类型 |       服务功能       |
| :----: | :----: | :------------------: |
|   0    |  确认  |         认可         |
|  1~7   |   -    |         备用         |
|   8    | 响应帧 |       用户数据       |
|   9    | 响应帧 | 否定：无所召唤的数据 |
|   10   |   -    |         备用         |
|   10   | 响应帧 |       链路状态       |
| 12~15  |   -    |         备用         |

本部分规定： 
- 启动站功能码 10（请求 1 级数据）用于应用层请求确认（CON=1）的链路传输；
- 启动站功能码 11（请求 2 级数据）用于应用层请求数据的链路传输。

## 地址域 A

地址域由地市区县码 A1、终端地址 A2、主站地址组成

| 省地市区县码A1 | 终端地址A2 | 主站地址A3 |
| :------------: | :--------: | :--------: |
|   3Byte BCD    | 3Byte BIN  | 1Byte BIN  |

1. 省地市区县码 A1

省地市区县码按 GB 2260-2007 的规定执行。 
当此通信的最终发起端和接收端为终端时，省地市区县码表示终端所属的省份、地市以及区县，A1 的高字节表示省份、中间字节表示地市码，低字节表示区县码。

2. 终端地址 A2

终端地址 A2 选址范围为 1~16777216。A2=000000H 为无效地址，A2=FFFFFFH 时表示系统广播地址。

3. 主站地址 A3

主站启动的发送帧的 MSA 应为非零值，其终端响应帧的 MSA 应与主站发送帧的 MSA 相同。 
终端启动发送帧的 MSA 应为零，其主站响应帧的 MSA 也应为零。

## 帧校验和

帧校验和是用户数据区所有字节的八位位组算术和，不考虑溢出位。用户数据区包括控制域、地址域、链路用户数据（应用层）三部分。

# 传输规则（链路传输）

1.  线路空闲状态为二进制 1，即为高电平；
2.  帧的字符之间无线路空闲间隔；两帧之间的线路空闲间隔最少需 33 位（根据链路波特率计算）；
3.  如按 步骤5 检出了差错，两帧之间的线路空闲间隔最少需 33 位；
4.  帧校验和（CS）是用户数据区的八位位组的算术和，不考虑进位位；
5.  接收方校验： 
	- 对于每个字符：校验起动位、停止位、偶校验位。 
	- 对于每帧： 
		- 检验帧的固定报文头中的开头和结束所规定的字符； 
		- 识别 2 个长度 L； 
		- 每帧接收的字符数为用户数据长度 L+8； 
		- 帧校验和； 
		- 结束字符； 
		- 校验出一个差错时，校验按步骤 3 的线路空闲间隔； 
  
若这些校验有一个失败，舍弃此帧；若无差错，则此帧数据有效。

## 帧拆分规则

对于终端的上行帧，如果一个数据帧无法容纳所有数据，那么可以将其拆分成多个数据帧应答。在需要主站确认帧的情况下，后续帧在接收到主站的确认帧之后再上送，而不需要主站的请求后续帧的命令；在无需主站确认帧的情况下，后续帧可以紧接着前一帧上送。除了中继命令和非标准报文外，拆分后的每一帧都是自描述的，其时间、信息点标识、数据标识及数据标识内容等仅对本帧数据有效。


## 非平衡传输过程

### 适用信道

半双工通道和专用无线通道应采用非平衡传输规则。 

### 发送／无回答服务

在前一次通信服务的传输过程结束后，并且至少间隔 33 个空闲位，才开始新一次发送传输。 

### 发送／确认服务

在前一次通信服务结束后，才能开始新一次发送帧传输。 

当从动站正确收到启动站报文，并能执行启动站报文的命令，则发送确认帧；否则发送否定帧 

### 请求／响应服务

在前一次通信服务结束后，才能开始新一次请求帧传输。 

从动站正确收到启动站请求 1 级数据帧，如所请求的数据全部有效，则发送响应帧；否则发送否定帧。 

从动站正确收到启动站请求 2 级数据帧，如所请求的数据全部有效，则发送响应帧；如所请求的数据部分有效，则根据能响应的数据内容组织数据单元标识发送响应帧；如所请求的数据全部无效，则发送否定帧。 

当 FCV 有效时，可采用防止报文丢失和报文重复传送：

未收到响应帧或响应帧受到干扰，则重发原报文且不改变 FCB 值，最大重发次数可设定。 在从动站收到启动站的请求帧，并向启动站发送响应帧，此时在从动站将此响应帧保存起来。在前后两次接收到的请求帧中的 FCB 值不同时，则清除原保存的响应帧，并形成新的响应帧；否则若前
后两个请求帧的 FCB 值相同，则重发原保存的响应帧。 

### 通信出错处理

启动站在规定时间内没有正确收到响应报文，作为超时处理，放弃该通信服务。超时时间应考虑信道网络延时、中继环节延时、终端响应时间等因素。在发送下一帧之前，需等待一个超时时间。 

从动站若检出帧出错则不作回答。

## 平衡传输过程

### 适用信道

全双工通道和数据交换网络通道可采用平衡传输规则。 

### 发送／无回答服务

启动站允许建立一个或多个通信服务。当同时建立多个通信服务时，由启动站进行数据流控制。 

### 发送／确认服务

启动站允许建立一个或多个通信服务。当同时建立多个通信服务时，由启动站进行数据流控制。 当从动站正确收到启动站报文时，并能执行启动站报文的命令，则发送确认帧；否则发送否定帧。

### 请求／响应服务

启动站允许建立一个或多个通信服务。当同时建立多个通信服务时，由启动站进行数据流控制。 

从动站正确收到启动站请求 1 级数据帧，如所请求的数据全部有效，则发送响应帧；否则发送否定帧。

从动站正确收到启动站请求 2 级数据帧，如所请求的数据全部有效，则发送响应帧；如所请求的数据部分有效，则根据能响应的数据内容组织数据单元标识发送响应帧；如所请求的数据全部无效，则发送否定帧。 

终端作为从动站响应新的请求服务之前，必须完成前一个请求服务的响应。 

当 FCV 有效时，可采用 FCB 位防止报文丢失和报文重复传送： 

未收到响应帧或响应帧受到干扰，则重发原报文并不改变 FCB 值，最大重发次数可设定。 

在从动站收到启动站的请求帧，并向启动站发送响应帧，此时在从动站将此响应帧保存起来。在前后两次接收到的请求帧中的 FCB 值不同时，则清除原保存的响应帧，并形成新的响应帧；否则若前后两个请求帧的 FCB 值相同，则重发原保存的响应帧。 

### 通信出错处理

启动站在规定时间内没有正确收到响应报文时，作为超时处理，放弃该通信服务。超时时间应考虑信道网络延时、中继环节延时、终端响应时间等因素。 

从动站若检出帧出错则不作回答。

# 应用层格式

| 应用层功能码 AFN | 帧序列域 SEQ | 信息点标识 1 | 数据标识编码 1 | 数据标识内容 1 |   数据时间域    |  ...  | 信息点标识 n | 数据标识编码 n | 数据标识内容 n |   数据时间域    | 消息认证码 PW | 时间标签 Tp |
| :--------------: | :----------: | :----------: | :------------: | :------------: | :-------------: | :---: | :----------: | :------------: | :------------: | :-------------: | :-----------: | :---------: |
|      1Byte       |    1Byte     |    2Byte     |     4Byte      |     N Byte     | (4+2+2+2+2)*2+1 |  ...  |    2Byte     |     4Byte      |     N Byte     | (4+2+2+2+2)*2+1 |    16Byte     |    5Byte    |



<div align="center"><img src="https://github.com/laneston/note/blob/main/00-img/Post-计量自动化终端上行通信规约/应用层功能码定义.jpg"></div>


