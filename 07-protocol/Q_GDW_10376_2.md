


| 起始字符68H | 长度L | 控制域C | 信息域R | 地址域A | 应用功能码AFN | 数据单元标识 | 应用数据 | 校验和CS | 结束字符16H |
| :---------: | :---: | :-----: | :-----: | :-----: | :-----------: | :----------: | :------: | :------: | :---------: |
|    1Byte    | 2Byte |  1Byte  |  6Byte  | 6+6*N+6 |     1Byte     |    2Byte     |  N Byte  |  1Byte   |    1Byte    |


## 控制域

|      D7       |      D6       |  D5-D0   |
| :-----------: | :-----------: | :------: |
| 传输方向位DIR | 启动标志位PRM | 通信方式 |


- 传输方向位DIR：0表示此帧报文是由集中器发出的下行报文；1表示此帧报文是由通信模块发出的上行报文。
- 启动标志位PRM：0表示此帧报文来自从动站；1表示次帧报文来自启动站。
- 通信方式：0保留；1集中式路由载波通信，值采用集中式路由方案的电力窄带载波通信；分布式路由载波通信，值采用分布式路由方案的电力窄带载波通信；3 HPLC载波通信，指采用电力线HPLC载波通信；4-9备用；10微功率无线-通信，值采用微功率无线组网的通信；11-19备用；20以太网通信；21-63备用。


## 信息域


### 下行报文

|  1 Byte  |          |              |              |          |   1 Byte   |          |     1 Byte     |    2 Byte    |          |   1 Byte   |
| :------: | :------: | :----------: | :----------: | :------: | :--------: | :------: | :------------: | :----------: | :------: | :--------: |
|  D7-D4   |    D3    |      D2      |      D1      |    D0    |   D7-D4    |  D3-D0   |     D7-D0      |     D15      |  D14-D0  |   D7-D0    |
| 中继级别 | 冲突检测 | 通信模块标识 | 附属节点标识 | 路由标识 | 纠错码标识 | 信道标识 | 预计应答字节数 | 速率单位标识 | 通信速率 | 报文序列号 |


- 路由标识：0表示通信模块带路由或工作在路由模式，1表示通信模块不带路由或工作在旁路模式；
- 附属节点标识：指从节点附属节点标识，0表示无附加节点，1表示有附加节点；
- 通信模块标识：0表示对主节点的操作，1表示对从节点操作；
- 冲突检测：0表示对主节点的操作，1表示对从节点操作；
- 中继级别：取值范围0-15，0表示无中继；
- 信道标识：取值0-15，0表示不分信道，1-15以此表示第1-15信道；
- 纠错编码标识：取值范围0-15,0表示信道未编码，1表示RS编码，2-15保留；
- 预计应答字节数：取值 0-255，用于计算延时等待时间，为0时，延时等待时间为默认时间；
- 通信速率：表示通信波特率，BIN格式，0表示默认通信速率；
- 速率单位标识：0表示bit/s，1表示kbit/s；
- 报文序列号：用以匹配上、下行报文的请求应答对应关系，值从0-255，循环使用。


### 上行报文


|  1 Byte  |       |              |       |          | 1 Byte |          |     1 Byte     |    2 Byte    |                  |      1 Byte      | 1 Byte |          |   1 Byte   |
| :------: | :---: | :----------: | :---: | :------: | :----: | :------: | :------------: | :----------: | :--------------: | :--------------: | :----: | :------: | :--------: |
|  D7-D4   |  D3   |      D2      |  D1   |    D0    | D7-D4  |  D3-D0   |     D7-D4      |    D3-D0     |      D7-D4       |      D3-D0       | D7-D1  |    D0    |   D7-D0    |
| 中继级别 |   0   | 通信模块标识 |   0   | 路由标识 |   0    | 信道标识 | 电能表通道特征 | 实测相线标识 | 末级应答信号品质 | 末级命令信号品质 |  预留  | 事件标志 | 报文序列号 |


- 路由标识：0表示通信模块带路由或工作在路由模式，1表示通信模块不带路由或工作在旁路模式；
- 通信模块标识：0表示对主节点的操作，1表示对从节点操作；
- 中继级别：取值范围0-15，0表示无中继；
- 信道标识：取值0-15，0表示不分信道，1-15以此表示第1-15信道；
- 实测相线标识：实测从节点逻辑主信号所在电源相别，0为不确定，1-3以此标识相别为第1相、第2相、第3相；
- 电能表通道特征：标书目的节点电表通道的特征，取值范围0-15，为保留，1表示物理信道为单相供电，逻辑信道为单信道；2表示物理信道为单相供电，逻辑信道为两信道；3表示物理信道为单相供电，逻辑信道为三信道；4表示物理信道为三相供电，逻辑信道为三信道；5-15为保留；
- 信号品质：分为15级，取值范围0-15,0表示无信号品质，1表示最低品质；
- 事件标志：D0为0时无上报事件，D0为1时有上报事件；
- 报文序列号：用以匹配上、下行报文的请求应答对应关系，值从0-255，循环使用。


## 地址域A

地址域由源地址A1、中继地址A2、目的地址A3组成，数据格式为BCD。

|  6Byte   | 6X中继级别 |   6Byte    |
| :------: | :--------: | :--------: |
| 源地址A1 | 中继地址A2 | 目的地址A3 |

-  当信息域的“通信模块标识”为0时，无地址域A；
-  当信息域的“通信模块标识”为1时，主节点下行时，原地址A1是指主节点的MAC地址，中继地址A2和目的地址A3是指从节点的MAC地址；从节点上行时，源地址A1是指从节点的MAC地址，无中继器地址A2，目的地址A3是指主节点的MAC地址；
-  当广播命令时，目的地址A3为广播地址 999999999999H。
-  

## 应用数据域


|   1Byte    |    2Byte     |       |  N Byte  |
| :--------: | :----------: | :---: | :------: |
|    AFN     |     DT1      |  DT2  |          |
| 应用功能码 | 数据单元标识 |       | 数据单元 |



数据单元标识由信息类标识DT组成，表示信息类型，DT由信息类元DT1和DT2两个字节构成。DT2采用二进制编码方式表示信息类组，DT1对位表示某一信息类组的1-8种信息类型，对此共同构成信息类标识Fn(N=1~248)



| 信息类组DT2 | 信息类元DT1 |       |       |       |       |       |       |       |
| :---------: | :---------: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
|    D7~D0    |     D7      |  D6   |  D5   |  D4   |  D3   |  D2   |  D1   |  D0   |
|      0      |     F8      |  F7   |  F6   |  F5   |  F4   |  F3   |  F2   |  F1   |
|     ...     |     ...     |  ...  |  ...  |  ...  |  ...  |  ...  |  ...  |  ...  |
|     30      |    F248     | F247  | F246  | F245  | F244  | F243  | F242  | F241  |



## 数据单元

举个例子说明：

确认帧AFN码为00，Fn定义为F1，数据单元格式如下表所示：

|            D7            |            D6            |            D5            |            D4            |            D3            |            D2            |            D1            |               D0               |
| :----------------------: | :----------------------: | :----------------------: | :----------------------: | :----------------------: | :----------------------: | :----------------------: | :----------------------------: |
| 7信道状态：0为忙；1为闲  | 6信道状态：0为忙；1为闲  | 5信道状态：0为忙；1为闲  | 4信道状态：0为忙；1为闲  | 3信道状态：0为忙；1为闲  | 2信道状态：0为忙；1为闲  | 1信道状态：0为忙；1为闲  | 命令状态：0为未处理；1为已处理 |
| 15信道状态：0为忙；1为闲 | 14信道状态：0为忙；1为闲 | 13信道状态：0为忙；1为闲 | 12信道状态：0为忙；1为闲 | 11信道状态：0为忙；1为闲 | 10信道状态：0为忙；1为闲 | 9信道状态：0为忙；1为闲  |    8信道状态：0为忙；1为闲     |
| 23信道状态：0为忙；1为闲 | 22信道状态：0为忙；1为闲 | 21信道状态：0为忙；1为闲 | 20信道状态：0为忙；1为闲 | 19信道状态：0为忙；1为闲 | 18信道状态：0为忙；1为闲 | 17信道状态：0为忙；1为闲 |    16信道状态：0为忙；1为闲    |
| 31信道状态：0为忙；1为闲 | 30信道状态：0为忙；1为闲 | 29信道状态：0为忙；1为闲 | 28信道状态：0为忙；1为闲 | 27信道状态：0为忙；1为闲 | 26信道状态：0为忙；1为闲 | 25信道状态：0为忙；1为闲 |    24信道状态：0为忙；1为闲    |

由上可得，确认帧上行报文如下：

| 起始字符 | 报文长度 | 控制域 |      信息域       |               地址域                | 应用功能码 | 数据单元标识 |     应用数据      | 校验和 | 结束字符 |
| :------: | :------: | :----: | :---------------: | :---------------------------------: | :--------: | :----------: | :---------------: | :----: | :------: |
|    68    |    20    |   83   | 04 01 11 44 00 07 | 00 00 00 00 00 11 00 00 00 00 00 02 |     00     |    00 01     | 01 01 00 00 00 05 |   82   |    16    |


## 应用层功能码 AFN

<div align="center"><img src="https://github.com/laneston/note/blob/main/00-img/Post-Q_GDW_10376_2/AFN-1.jpg"></div>

<div align="center"><img src="https://github.com/laneston/note/blob/main/00-img/Post-Q_GDW_10376_2/AFN-2.jpg"></div>

<div align="center"><img src="https://github.com/laneston/note/blob/main/00-img/Post-Q_GDW_10376_2/AFN-3.jpg"></div>
