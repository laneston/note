


| 起始字符68H | 长度L | 控制域C | 信息域R | 地址域A | 应用功能码AFN | 数据单元标识 | 应用数据 | 校验和CS | 结束字符16H |
| :---------: | :---: | :-----: | :-----: | :-----: | :-----------: | :----------: | :------: | :------: | :---------: |
|    1Byte    | 2Byte |  1Byte  |  6Byte  | 6+6*N+6 |     1Byte     |    2Byte     |  N Byte  |  1Byte   |    1Byte    |


## 控制域

|      D7       |      D6       |  D5-D0   |
| :-----------: | :-----------: | :------: |
| 传输方向位DIR | 启动标志位PRM | 通信方式 |


- 传输方向位DIR：0表示此帧报文是由集中器发出的下行报文；1表示此帧报文是由通信模块发出的上行报文。
- 启动标志位PRM：0表示此帧报文来自从动站；1表示次帧报文来自启动站。
- 通信方式：0保留；1集中式路由载波通信，值采用集中式路由方案的电力窄带载波通信；分布式路由载波通信，值采用分布式路由方案的电力窄带载波通信；3 HPLC载波通信，指采用电力线HPLC载波通信；4-9备用；10微功率无线-通信，值采用微功率无线组网的通信；11-19备用；20以太网通信；21-63备用。


## 信息域


### 下行报文

|  1 Byte  |          |              |              |          |   1 Byte   |          |     1 Byte     |    2 Byte    |          |   1 Byte   |
| :------: | :------: | :----------: | :----------: | :------: | :--------: | :------: | :------------: | :----------: | :------: | :--------: |
|  D7-D4   |    D3    |      D2      |      D1      |    D0    |   D7-D4    |  D3-D0   |     D7-D0      |     D15      |  D14-D0  |   D7-D0    |
| 中继级别 | 冲突检测 | 通信模块标识 | 附属节点标识 | 路由标识 | 纠错码标识 | 信道标识 | 预计应答字节数 | 速率单位标识 | 通信速率 | 报文序列号 |


- 路由标识：0表示通信模块带路由或工作在路由模式，1表示通信模块不带路由或工作在旁路模式；
- 附属节点标识：指从节点附属节点标识，0表示无附加节点，1表示有附加节点；
- 通信模块标识：0表示对主节点的操作，1表示对从节点操作；
- 冲突检测：0表示对主节点的操作，1表示对从节点操作；
- 中继级别：取值范围0-15，0表示无中继；
- 信道标识：取值0-15，0表示不分信道，1-15以此表示第1-15信道；
- 纠错编码标识：取值范围0-15,0表示信道未编码，1表示RS编码，2-15保留；
- 预计应答字节数：取值 0-255，用于计算延时等待时间，为0时，延时等待时间为默认时间；
- 通信速率：表示通信波特率，BIN格式，0表示默认通信速率；
- 速率单位标识：0表示bit/s，1表示kbit/s；
- 报文序列号：用以匹配上、下行报文的请求应答对应关系，值从0-255，循环使用。


### 上行报文


|  1 Byte  |       |              |       |          | 1 Byte |          |     1 Byte     |              |      1 Byte      |                  | 1 Byte |          |   1 Byte   |
| :------: | :---: | :----------: | :---: | :------: | :----: | :------: | :------------: | :----------: | :--------------: | :--------------: | :----: | :------: | :--------: |
|  D7-D4   |  D3   |      D2      |  D1   |    D0    | D7-D4  |  D3-D0   |     D7-D4      |    D3-D0     |      D7-D4       |      D3-D0       | D7-D1  |    D0    |   D7-D0    |
| 中继级别 |   0   | 通信模块标识 |   0   | 路由标识 |   0    | 信道标识 | 电能表通道特征 | 实测相线标识 | 末级应答信号品质 | 末级命令信号品质 |  预留  | 事件标志 | 报文序列号 |


- 路由标识：0表示通信模块带路由或工作在路由模式，1表示通信模块不带路由或工作在旁路模式；
- 通信模块标识：0表示对主节点的操作，1表示对从节点操作；
- 中继级别：取值范围0-15，0表示无中继；
- 信道标识：取值0-15，0表示不分信道，1-15以此表示第1-15信道；
- 实测相线标识：实测从节点逻辑主信号所在电源相别，0为不确定，1-3以此标识相别为第1相、第2相、第3相；
- 电能表通道特征：标书目的节点电表通道的特征，取值范围0-15，为保留，1表示物理信道为单相供电，逻辑信道为单信道；2表示物理信道为单相供电，逻辑信道为两信道；3表示物理信道为单相供电，逻辑信道为三信道；4表示物理信道为三相供电，逻辑信道为三信道；5-15为保留；
- 信号品质：分为15级，取值范围0-15,0表示无信号品质，1表示最低品质；
- 事件标志：D0为0时无上报事件，D0为1时有上报事件；
- 报文序列号：用以匹配上、下行报文的请求应答对应关系，值从0-255，循环使用。


## 地址域A

地址域由源地址A1、中继地址A2、目的地址A3组成，数据格式为BCD。

|  6Byte   | 6X中继级别 |   6Byte    |
| :------: | :--------: | :--------: |
| 源地址A1 | 中继地址A2 | 目的地址A3 |

-  当信息域的“通信模块标识”为0时，无地址域A；
-  当信息域的“通信模块标识”为1时，主节点下行时，原地址A1是指主节点的MAC地址，中继地址A2和目的地址A3是指从节点的MAC地址；从节点上行时，源地址A1是指从节点的MAC地址，无中继器地址A2，目的地址A3是指主节点的MAC地址；
-  当广播命令时，目的地址A3为广播地址 999999999999H。
-  

## 应用数据域


|   1Byte    |    2Byte     |       |  N Byte  |
| :--------: | :----------: | :---: | :------: |
|    AFN     |     DT1      |  DT2  |          |
| 应用功能码 | 数据单元标识 |       | 数据单元 |



数据单元标识由信息类标识DT组成，表示信息类型，DT由信息类元DT1和DT2两个字节构成。DT2采用二进制编码方式表示信息类组，DT1对位表示某一信息类组的1-8种信息类型，对此共同构成信息类标识Fn(N=1~248)



| 信息类组DT2 | 信息类元DT1 |       |       |       |       |       |       |       |
| :---------: | :---------: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
|    D7~D0    |     D7      |  D6   |  D5   |  D4   |  D3   |  D2   |  D1   |  D0   |
|      0      |     F8      |  F7   |  F6   |  F5   |  F4   |  F3   |  F2   |  F1   |
|     ...     |     ...     |  ...  |  ...  |  ...  |  ...  |  ...  |  ...  |  ...  |
|     30      |    F248     | F247  | F246  | F245  | F244  | F243  | F242  | F241  |



## 数据单元

举个例子说明：

确认帧AFN码为00，Fn定义为F1，数据单元格式如下表所示：

|            D7            |            D6            |            D5            |            D4            |            D3            |            D2            |            D1            |               D0               |
| :----------------------: | :----------------------: | :----------------------: | :----------------------: | :----------------------: | :----------------------: | :----------------------: | :----------------------------: |
| 7信道状态：0为忙；1为闲  | 6信道状态：0为忙；1为闲  | 5信道状态：0为忙；1为闲  | 4信道状态：0为忙；1为闲  | 3信道状态：0为忙；1为闲  | 2信道状态：0为忙；1为闲  | 1信道状态：0为忙；1为闲  | 命令状态：0为未处理；1为已处理 |
| 15信道状态：0为忙；1为闲 | 14信道状态：0为忙；1为闲 | 13信道状态：0为忙；1为闲 | 12信道状态：0为忙；1为闲 | 11信道状态：0为忙；1为闲 | 10信道状态：0为忙；1为闲 | 9信道状态：0为忙；1为闲  |    8信道状态：0为忙；1为闲     |
| 23信道状态：0为忙；1为闲 | 22信道状态：0为忙；1为闲 | 21信道状态：0为忙；1为闲 | 20信道状态：0为忙；1为闲 | 19信道状态：0为忙；1为闲 | 18信道状态：0为忙；1为闲 | 17信道状态：0为忙；1为闲 |    16信道状态：0为忙；1为闲    |
| 31信道状态：0为忙；1为闲 | 30信道状态：0为忙；1为闲 | 29信道状态：0为忙；1为闲 | 28信道状态：0为忙；1为闲 | 27信道状态：0为忙；1为闲 | 26信道状态：0为忙；1为闲 | 25信道状态：0为忙；1为闲 |    24信道状态：0为忙；1为闲    |

由上可得，从机回复主机的确认帧上行报文如下：

| 起始字符 | 报文长度 | 控制域 |      信息域       |               地址域                | 应用功能码 | 数据单元标识 |     应用数据      | 校验和 | 结束字符 |
| :------: | :------: | :----: | :---------------: | :---------------------------------: | :--------: | :----------: | :---------------: | :----: | :------: |
|    68    |    20    |   83   | 04 01 11 44 00 07 | 00 00 00 00 00 11 00 00 00 00 00 02 |     00     |    00 01     | 01 01 00 00 00 05 |   82   |    16    |


## 应用层功能码 AFN

<div align="center"><img src="https://github.com/laneston/note/blob/main/00-img/Post-Q_GDW_10376_2/AFN-1.jpg"></div>

<div align="center"><img src="https://github.com/laneston/note/blob/main/00-img/Post-Q_GDW_10376_2/AFN-2.jpg"></div>

<div align="center"><img src="https://github.com/laneston/note/blob/main/00-img/Post-Q_GDW_10376_2/AFN-3.jpg"></div>




# 集中器与本地通信模块交互流程

## 1. 初始化流程

1. 集中器通过RESET管教复位路由；
2. 集中器等待通信单元上报（AFN=03H-F10）等待1min，超时则主动下发“本地通信模块运行模式信息”查询命令（AFN=03H-F10）；
3. 若本地通信模块的主节点地址与集中器不匹配，则下发“设置主节点地址”命令（AFN=05H-F1）；
4. 根据已知的本地通信模块运行模式参数确定集中器相关抄表机制。

## 2. 档案同步流程

1. 集中器下发“从节点数量”命令（AFN=10H-F1）查询路由从节点数量；
2. 集中器下发“从节点信息”命令（AFN=10H-F2）读取路由模块的表档案地址；
3. 返回节点信息与集中器节点信息比较，通过“删除从节点”（AFN=11H-F2），或者“参数区初始化”（AFN=01H-F2）删除电表地址，然后通过“添加从节点”（AFN=11H-F1）添加电表地址，最终达到模块和集中器电表档案一致。

 ## 3. 点抄流程（监控从节点）

1. 集中器使用“暂停”命令暂停路由工作（AFN=12H-F2）；
2. 集中器向路由发送“监控从节点”命令（AFN=13H-F1下行），等待路由返回应答；
3. 路由应答数据帧（AFN=13H-F1上行），集中器处理数据，按监控从节点最大超时时间等待响应（默认90s）；
4. 集中器等待90s判断是否继续监控，如果仍然存在则回到步骤2，如果没有监控任务则流程结束。


## 4. 从节点主动注册流程（搜表）

1. 集中器发送“暂停”命令（AFN=12H-F2），停止抄表流程；
2. 集中器下发“激活从节点主动注册”（AFN=11H-F5下行）；
3. 集中器收到“上报从节点信息及设备类型”（AFN=06H-F4上行）或“上报从节点信息”（AFN=06H-F1上行），保存处理上报信息并确认，重复步骤3；
4. 载波模块10min内为上报注册信息时，集中器下发“路由运行状态”（AFN=10H-F4），根据运行状态字中的“工作标志”状态决定是否继续上报；或者收到路由主动上报的“路由工况变动信息”（AFN=12H-F3），获知主动注册已经结束，回复确认报文（AFN=00H-F1）后终止主动注册流程；
5. 集中器根据上报节点信息，必要的话进行档案同步，若有抄表任务可根据任务特点发送“回复”命令（AFN=12H-F3）或“重启”命令（AFN=12H-F1），开始抄表流程；

## 5. 定期或周期抄表流程

### 集中器主动方式

1. 集中器下发“暂停”命令（AFN=12H-F2），停止路由主动模式抄表流程；
2. 集中器下发“监控从节点”命令（AFN=13H-F1），并设置下发报文的本地通信延时相关性标志，需要考虑延时的情况，需要响应路由发来的“通信延时修正通信数据”的请求，收到监控结果处理数据；循环以上操作直至抄表完成或抄表时段结束；
3. 集中器发送“恢复”命令（AFN=12H-F3），恢复抄表流程。


### 路由模块主动方式

1. 集中器检测到抄表时段已到，执行完档案同步流程后，发送“重启”命令（AFN=12H-F1）或“恢复”命令（AFN=12H-3）启动抄读流程，并等待接收数据；
2. 接收数据后，检索集中器电表档案；若表档案不存在该电表，则调用“档案同步流程”后重新启动抄表；
3. 若集中器表档案中存在该表且报文为“路由请求抄读内容”（AFN=14H-F1）命令时，集中器返回“路由请求抄读内容”（AFN=14H-F1下行），其中的抄读标志项表示了“可以抄读”、“抄读成功”及“抄读失败”等三种方案，响应报文的信道标识和电表地址要和请求报文匹配；当抄读标志为“可以抄读”， 并且待抄读报文与具体“通信延时”相关的情况，将“通信数据延时相关标志”置为01H，否则置位00H；
4. 若集中器表档案中存在该表且报文为“上报抄读数据”（AFN=06H-F2）命令时，返回确认报文（AFN=00H-F1），响应报文的信道标识和上报报文匹配，并记录抄读数据；
5. 若集中器收到的报文为“请求依通信延时修正通信数据”时，集中器根据具体的通信延时进行通信数据修正，并返回通信结果（AFN=14H-F3）；
6. 退出抄表周期后，集中器发送暂停命令（AFN=12H-F2），停止路由主动模式抄表流程，等待下一抄表周期。

### 广播流程中通信延时相关报文通信机制流程

1. 集中器存在广播任务时，通过“暂停”命令控制路由进入空闲状态，然后判断广播数据的通信延时相关性；
2. 如果广播数据和本地信道的通信延时相关（如“电表校时”的广播命令），则首先发送“通信延时相关广播通信时长”查询命令（AFN=03H-F9），获得当前报文在目前的本地通信环境中的具体通信时长，由此修正具体的广播数据；
3. 将修正过的广播数据通过“启动广播”命令（AFN=05H-F3），发送给本地通信，并依据返回的确认报文中的等待完成时间进行等待。




<div align="center"><img src="https://github.com/laneston/note/blob/main/00-img/Post-Q_GDW_10376_2/init.jpg"></div>