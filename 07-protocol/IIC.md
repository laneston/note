


# 信号规则

IIC是串行传输总线，数据是按照bit位进行传输


<div align="center"><img src="https://github.com/laneston/note/blob/main/00-img/Post-IIC/iicTiming.png"></div>


IIC有两根线，一根是SCL时钟线，类似于一个节拍器，另一根时候SDA数据线，高低电平表示0和1。

## 起始和停止

SCL是高电平时，SDA线从高电平向低电平切换（下降沿），为起始信息；
SCL是高电平时，SDA线从低电平向高电平切换（上升沿），为停止信息；

起始事件开始后总线处于忙碌状态，停止事件开始后总线处于空闲状态。




## 响应ACK和非响应信号NACK

由从机发送，主机接收。

响应信号：每个字节传输必须带响应位，相关的响应时钟也由主机产生，在响应的时钟脉冲期间（第9个时钟周期），**发送端**释放SDA线，**接收端**把SDA拉低并在时钟信号为高时保持低电平，这样就产生了 ACK 信号，从而使得主机知道从机已成功接收数据并且准备好了接收下一数据。

非响应信号：当在SCL第9位时钟高电平信号期间，SDA仍然保持高电平，这种情况定义为NACK非响应位。这种情况下，主机可以直接产生STOP条件终止以后的传输或者继续重新START开始一个新的传输。

以下情况会导致出现NACK位：

- 发送方寻址的接收方在总线上不存在，因此总线上没有设备应答
- 接收方正在处理一些实时的功能，尚未准备好与主机通信，因此接收方不能执行收发
- 在传输期间，接收方收到不能识别的数据或者命令
- 在传输期间，接收方无法接收更多的数据字节
- 主机接收完成读取数据后，要发送NACK结束告知从机


## 重复开始

ACK信号后，SCL高电平为低时，SDA立即拉高，在下一个SCL高电平时，SDA线从高电平向低电平切换（下降沿），发送一个起始信号。



# 数据读写

I2C 总线中的设备必须要有唯一的地址，这意味着如果在总线中接入两个相同的设备，该设备必须有配置地址的功能，这也是我们经常用的 I2C 接口的设备会有几个引脚用来配置地址的原因。


## 数据写操作

1. 在起始信息之后，紧接着是从机地址信息，从机地址是7bit，一个7bit的地址是从最高位（MSB）开会发送的，这个地址最后一位是读写操作符，也就是说 ADDR(7bit)+W(1bit)组成一个字节（主机发送，从机接收）；
2. 紧接着是一个bit的ACK/NACK（从机发送，主机接收）；
3. 如果前面的过程都正常，则主机继续发送需要操作的寄存器地址（1个byte）（主机发送，从机接收）；
4. 紧接着是一个bit的ACK/NACK（从机发送，主机接收）；
5. 如果前面的过程都正常，则主机继续发送写入寄存器的数据（1个byte或多个byte）（主机发送，从机接收）；
6. 每个byte都会跟着一个bit的ACK/NACK（从机发送，主机接收）；
7. 发送完成后主机发送停止信息（主机发送，从机接收）。

## 数据读操作

1. 在起始信息之后，紧接着是从机地址信息，从机地址是7bit，一个7bit的地址是从最高位（MSB）开会发送的，这个地址最后一位是读**写操作符**，也就是说 ADDR(7bit)+W(1bit)组成一个字节（主机发送，从机接收）；
2. 紧接着是一个bit的ACK/NACK（从机发送，主机接收）；
3. 如果前面的过程都正常，则主机继续发送需要操作的寄存器地址（1个byte）（主机发送，从机接收）；
4. 紧接着是一个bit的ACK/NACK（从机发送，主机接收）；
5. 如果前面的过程都正常，则主机发送**重复开始信号**（主机发送，从机接收）；
6. 重复开始信号之后，紧接着是从机地址信息，从机地址是7bit，一个7bit的地址是从最高位（MSB）开会发送的，这个地址最后一位是读**读操作符**，也就是说 ADDR(7bit)+r(1bit)组成一个字节（主机发送，从机接收）；
7. 紧接着是一个bit的ACK/NACK（从机发送，主机接收）；
8. 如果前面的过程都正常，则主机将释放SDA总线，由从机控制，主机监听从机发送的数据，主机每接收1byte数据，主机会发送ACK信号给从机，表示继续接收，如果主机发送NACK信号给从机，表示接收结束，告知从机释放总线，最后主机发送停止信号，完成读操作。








