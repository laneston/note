# 概述

应用层服务对象是构成客户机和服务器应用层的主要组件，它使用数据链路层提供的服务，服务规范包含客户机和服务器应用进程在各自应用层的逻辑接口，并向应用进程提供服务。客户机和服务器的应用服务对象都包括预连接、应用连接和数据交换三个必备组件。


<div align="center"><img src="https://github.com/laneston/note/blob/main/00-img/Post-DL_T698_45-application/计量主站连接流程.jpg.jpg"></div>


<div align="center"><img src="https://github.com/laneston/note/blob/main/00-img/Post-DL_T698_45-application/应用层通信流程.jpg"></div>


# 预连接

预连接服务适用于交换网络传输信道，如以太网、GPRS等，当其完成物理连接，建立透明通道后，需要在此通道上建立预连接并进行管理。

预连接服务（LINK）由服务器发起，客户机响应，LINK服务包括：


1. 登录：在完成物理连接，建立透明通道后，服务器应用进程按预连接配置参数向指定客户机发出登录请求，客户机应用进程给予确认，完成预连接。
2. 心跳：服务器采用“心跳”的方式来保证预连接通道处于活动状态。
3. 退出登录：在建立预连接后，不允许服务器主动断开。若要变更，需重新配置服务器预连接参数，服务器在重启后生效；或接收到客户机执行“复位”方法后，向原客户机发出退出登录指示，然后再按照新配参数执行新的预连接登录。

对于**本地通信信道**，如**RS485、红外**等，当物理连接建立时，默认预连接的通道即存在，不需要额外的建立以及预连接管理。

# 应用连接

为访问服务器的接口类对象，首先要建立一个应用连接，并创建一个可以相互通信的语境。这个语境主要包含：应用语境的信息、使用身份验证机制的信息，以及其他需要的信息，这些信息包含在“应用连接”的接口类对象中。

服务器可以授予不同的访问权限给应用连接，访问权限涉及一组接口类对象，这组对象可以在给定的应用连接内被访问，即可视对象。

客户机可以通过读取应用连接对象的“可访问对象列表”属性而获得可视对象列表，即应用连接窗口，并利用应用连接对象所提供的方法，在已建立的应用连接内获得当前语境等更多的信息。

在预连接通道上，默认具有一个最低权限级别的应用连接窗口，即“预建立的应用连接窗口”，在此窗口内，客户机不需要进行应用连接协商以及安全认证等便可访问该应用连接窗口的内容。

建立应用连接（CONNECT），由客户机向服务器发起，用于确认客户机和服务器双方通信的应用语境，包含协议一致性、功能一致性以及安全认证等内容。

**服务器可同时支持若干个应用连接，互不干扰，但对同一个客户机，同时仅支持一个应用连接，当同一个客户机再次请求建立应用连接时，服务器如接受了客户机的再次请求，则前一个应用连接自动失效。**

断开应用连接（RELEASE）用于正常断开一个已经建立的应用连接。由于不允许服务器提出正常断开应用连接的请求，所以RELEASE.request服务只能由客户机提出，并且通常情况下，服务器不得拒绝此请求。

每一个应用连接在建立过程中，可以协商应用连接的静态超时时间，当连续无通信时间达到静态超时时间后，服务器将使用RELEASE.notification通知客户机，应用连接失效将被断开，此服务不需要客户机做任何响应。


预连接时建立的应用连接不需要使用CONNECT服务，即认为CONNECT已经完成，因此，预连接时建立的应用连接可以看成是在客户机和服务器之间完成预连接时应用连接已经存在，任何时候它都不能被断开，仅具有最低权限级别，窗口内容由服务器定义。这种应用连接简化了客户机和服务器之间数据交换，省掉了建立和断开应用连接阶段，仅有数据交换阶段。**当客户机需要得到较高权限的服务器服务时，客户机必须发起建立较高权限的应用连接。**


# 数据交换

数据交换服务是用于客户机和服务器之间的数据交换，是通过逻辑名引用来访问接口对象的属性或方法。

这些服务可分为两种通信类型：请求/响应类型、通知/确认类型。

请求/响应类数据交换服务是：读取（GET）、设置（SET）、操作（ACTION）、代理（PROXY）。

通知/确认类数据交换服务是：上报（REPORT）。

请求/响应类数据交换服务是通过客户机和服务器应用进程之间的数据交换来提供并完成的，即：客户机应用进程通过调用应用层的某个服务请求XX.request，服务器应用层接收到客户机请求后向服务器应用进程发出服务指示XX.indication，然后应用进程通过调用服务XX.response以响应客户机请求，客户机应用层接收到服务器响应后向客户机应用进程返回服务确认XX.confirm。

对于请求/响应类数据通信服务，在通信语境商定后，客户机和服务器的数据通信服务集是完全对等互补的，即：服务集相同，只是XX.request服务换成了XX.indication服务，XX.response服务换成了XX.confirm服务。因此，一个XX.request的APDU与一个XX.indication的APDU对等；一个XX.response的APDU与一个XX.confirm的APDU对等。

通知/确认类数据交换服务也是通过客户机和服务器应用进程之间的数据交换来提供并完成的，即：在客户机向服务器定制了主动上报的情况下，服务器应用进程通过调用应用层服务YY. notification，客户机应用层接收到服务器上报后向客户机应用进程发出服务指示YY.indication，然后客户机应用进程通过调用服务YY.response向服务器予以确认响应，服务器应用层接收到客户机确认响应后向服务器应用进程返回服务确认YY.confirm。


# 有关传输的时间标签

时间标签用于传输的时序和时效性判断，其包括一个开始发送时间和一个允许传输延时时间。

允许传输延时时间，是指从开始发送至对方接收到能解析的完整的应用层数据单元之间所允许的传输延时时间。

对于请求/响应类数据交换服务，时间标签由客户机产生，随请求传送给服务器，服务器据此判决收到的请求的时序和时效性，如判别有效，响应收到的请求，并在响应中将接收到的时间标签返回客户机。

对于通知/确认类数据通信服务，时间标签由服务器产生，随通知传送给客户机，客户机据此判决收到的通知的时序和时效性，如判别有效，确认收到的通知，并在确认中将接收到的时间标签返回服务器。

时效性判断规则：在时间标签中允许传输延时时间大于零的前提下，如果接收方的当前时间与时间标签中的开始发送时间之间的时差大于时间标签中的允许传输延时时间，则放弃处理；反之，则处理。

# 有关服务器信息上报

## 服务器上报服务

服务器上报服务（REPORT）是通过“注册-通知-撤销注册”的机制给客户机提供的一种系统级服务。客户机可通过GET服务查询出服务器支持的可注册后上报的服务集（如事件或定时数据上报等），并可根据系统需求通过SET服务以自定义形式注册部分或全部服务。注册成功后，服务器在检测到上报条件满足时（如产生了事件或定时上报时间到等），通过REPORT.notification服务及时通知客户机。

**该服务默认对远程通道有效，本地通道提供同样服务应由服务器界面提供相关信息指示，并经配置后使用。**

## 服务器APDU的跟随上报信息域

服务器应用层协议数据单元（APDU）中的可选的跟随上报信息域，是当系统不适合或服务器不支持上报服务（REPORT）时，用于作为ACD标志事件上报方式的补充，以实现更及时上报客户机注册的上报信息。

**该域同样默认对远程通道选择性有效，本地通道提供同样服务应由服务器界面提供相关信息指示，并经配置后使用。**



