# pair protocol(nng)


NNG 的配对协议有两个版本（pair0与pair1）。nng_pair 协议实现了配对模式，其中配对之间的关系是一对一的，此协议的**版本1**支持一种可选的多变量模式，其中配对方可以维护多个伙伴关系，使用此模式需要在应用程序中增加一些复杂性。版本0是此协议的旧版本。它缺少一些头部信息，适合构建简单的一对一拓扑。


函数 nng_pair_open() 创建一个配对 socket 。通常情况，如果没有配对方能够接收消息，则在尝试发送消息时，此模式会阻塞。即使这种模式看起来“可靠”，因为 back-pressure 在大多数情况下都会阻止丢弃消息，但仍存在涉及设备的拓扑（nng_device（3））或可能丢弃消息的原始模式sockets。需要可靠消息通信的应用程序应考虑使用 nng_req（7）socket，或在 pair sockets 的上层实现它们自己的确认层。

为了避免信道阻塞情况，多元模式 pair sockets （仅限版本1）在无法将消息传递给节点时丢弃消息。当与 nng_device（3）一起使用时，协议版本1提供了改进的环路保护，它还提供了在单个sockets上形成多节点关系的多元模式。


## Polyamorous Mode


通常 pair sockets 用于一对一通信，如果某个节点已经与另一节点建立了活动连接，则该节点将拒绝新连接。


在多元模式下，sockets 可以支持多个一对一连接。在此模式下，应用程序必须通过使用 nng_msg_set_pipe（3）函数设置传出消息上的管道 ID 值来选择远程节点以接收传出消息。通常，使用nng_msg_get_pipe（3）从传入消息中获取传出管道 ID 的值，例如在回复传入消息时。
为了防止信道阻塞，如果给定管道上的对等方无法接收（或管道不再可用，例如对等方已断开连接），则消息将被丢弃，而不会通知发送方。 




## Protocol Options


**NNG_OPT_PAIR1_POLY**

（仅限版本1）。此选项使能多元模式。该值是读写的，采用整数布尔值。默认的false值（0）表示应该使用传统的单配模式。

**NNG_OPT_MAXTTL**


（仅限版本1）。最长生存时间。此选项是一个介于0和255之间的整数值，包括0到255，是消息在被丢弃之前可以通过的最大"跃点"数。默认值为8。值为0可用于禁用环路保护，从而允许无限次的跳数。

转发路径上的每个节点可能有自己的最大生存时间值，并在转发消息之前执行自己的检查。因此，如果拓扑中的所有节点都对此选项使用相同的值，则会很有帮助。


## Protocol Headers

pair 协议使用1个32位无符号值作为协议头部。此值的低位（大端）字节包含一个“跃点”计数，并与 NNG_OPT_MAXTTL 选项结合使用，以防止设备转发循环。该值初始化为1，并在新节点每次接收到消息时递增。 


# nng_req（7）请求方

nng_req - request protocol

```
#include <nng/protocol/reqrep0/req.h>

int nng_req0_open(nng_socket *s);
```

nng_req 协议是请求/应答模式的一半。在这种模式中，请求者将消息发送给一个应答者，该应答者将进行应答。如果没有回复，则重新发送请求，直到收到回复或请求超时。此协议在设置类似RPC的服务时很有用，它也是“可靠的”，因为请求者会一直重试，直到收到回复。因为请求是重新发送的，所以它们必须是幂等的，以确保即使面对可能发生的重复请求（例如，如果由于某种原因丢失了回复消息），也可以进行可预测和可重复的行为。

除非处于“原始”模式（通过NNG_OPT_raw），否则请求者通常一次只有一个未完成的请求，并且通常会尝试将工作请求传播到不同的对等副本。



# Unix domain socket 

Unix domain socket 又叫 IPC(inter-process communication 进程间通信) socket，用于实现同一主机上的进程间通信。socket 原本是为网络通讯设计的，但后来在 socket 的框架上发展出一种 IPC 机制，就是 UNIX domain socket。虽然网络 socket 也可用于同一台主机的进程间通讯(通过 loopback 地址 127.0.0.1)，但是 UNIX domain socket 用于 IPC 更有效率：不需要经过网络协议栈，不需要打包拆包、计算校验和、维护序号和应答等，只是将应用层数据从一个进程拷贝到另一个进程。这是因为，IPC 机制本质上是可靠的通讯，而网络协议是为不可靠的通讯设计的。
UNIX domain socket 是全双工的，API 接口语义丰富，相比其它 IPC 机制有明显的优越性，目前已成为使用最广泛的 IPC 机制，比如 X Window 服务器和 GUI 程序之间就是通过 UNIX domain socket 通讯的。
Unix domain socket 是 POSIX 标准中的一个组件，所以不要被名字迷惑，linux 系统也是支持它的。
